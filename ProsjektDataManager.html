<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>ProsjektDataManager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#0069d9;
      --border:#e5e7eb;
      --card:#ffffff;
      --bg:#f5f5f7;
      --text:#111827;
      --muted:#6b7280;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body{ margin:0; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }
    header{
      display:flex; align-items:center; gap:14px;
      padding:12px 14px; background:var(--card); border-bottom:1px solid var(--border);
    }
    .logoBox{
      width:92px; height:92px; border-radius:12px; background:#fff; border:1px solid #eee;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      box-shadow:0 1px 3px rgba(15,23,42,.08); flex:0 0 auto;
    }
    .logoBox img{ width:84px; height:84px; object-fit:contain; display:block; }
    .titleBlock{ display:flex; flex-direction:column; gap:2px; }
    .title{ font-weight:800; font-size:18px; color:var(--primary); line-height:1.1; }
    .org{ font-weight:700; font-size:13px; opacity:.9; }
    .dev{ font-size:11px; opacity:.75; font-style:italic; }

    .headerRight{ margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    #status{ font-size:12px; opacity:.85; white-space:nowrap; max-width:520px; overflow:hidden; text-overflow:ellipsis; }
    button{
      padding:8px 10px; border-radius:8px; border:1px solid var(--primary);
      background:var(--primary); color:#fff; font-size:13px; font-weight:600; cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    button:disabled{ opacity:.6; cursor:default; }

    .loading-spinner{
      display:inline-block; width:12px; height:12px; border-radius:50%;
      border:2px solid #ccc; border-top-color:var(--primary);
      animation:spin .8s linear infinite; margin-right:6px; vertical-align:-2px;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    main{ flex:1; display:flex; flex-direction:column; padding:12px 14px 18px 14px; gap:12px; overflow:auto; }
    #error{ font-size:13px; color:#b00020; white-space:pre-wrap; }

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(360px, 1fr));
      gap:0;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:var(--card);
    }
    .card{
      background:var(--card);
      padding:12px 12px 14px 12px;
      display:flex;
      flex-direction:column;
      min-height:280px;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }
    .card h2{ margin:0 0 8px 0; font-size:14px; font-weight:800; }
    .divider{ height:1px; background:var(--border); margin:8px 0 10px 0; }
    .small-text{ font-size:12px; color:var(--muted); margin-top:8px; white-space:pre-wrap; }
    canvas{ width:100% !important; height:280px !important; }

    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      background:#fff; border:1px solid var(--border); border-radius:14px;
      padding:10px 12px; min-width:220px; flex:1;
    }
    .kpi .label{ font-size:12px; color:var(--muted); font-weight:800; }
    .kpi .value{ font-size:20px; font-weight:900; margin-top:2px; }
  </style>
</head>

<body>
  <header>
    <div class="logoBox">
      <img src="norconsult-logo-black.png" alt="Norconsult logo"
           onerror="this.style.display='none'; this.parentElement.textContent='Norconsult'; this.parentElement.style.fontWeight='900';">
    </div>

    <div class="titleBlock">
      <div class="title">ProsjektDataManager</div>
      <div class="org">Norconsult Norge</div>
      <div class="dev">Developed by Edin Dzakmic, Norconsult, (AI-assisted development)</div>
    </div>

    <div class="headerRight">
      <div id="status"><span class="loading-spinner"></span>Kobler til Trimble Connect…</div>
      <button id="refreshBtn">Oppdater data</button>
    </div>
  </header>

  <main>
    <div id="error"></div>

    <div class="kpiRow">
      <div class="kpi">
        <div class="label">Views (antall)</div>
        <div class="value" id="viewsCount">–</div>
      </div>
      <div class="kpi">
        <div class="label">Releases (antall)</div>
        <div class="value" id="releasesCount">–</div>
      </div>
      <div class="kpi">
        <div class="label">Custom Groups (antall)</div>
        <div class="value" id="groupsCount">–</div>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h2>Custom Groups – antall personer per gruppe</h2>
        <div class="divider"></div>
        <canvas id="groupsChart"></canvas>
        <div class="small-text" id="groupsNote"></div>
      </div>

      <div class="card">
        <h2>Explorer – antall filer per mappe</h2>
        <div class="divider"></div>
        <canvas id="foldersChart"></canvas>
        <div class="small-text" id="foldersNote"></div>
      </div>

      <div class="card">
        <h2>Aktiviteter – fordeling per aktivitetstype</h2>
        <div class="divider"></div>
        <canvas id="activityChart"></canvas>
        <div class="small-text" id="activityNote"></div>
      </div>
    </div>
  </main>

<script>
  // ===== STATE =====
  let API=null;

  let groupsChart=null;
  let foldersChart=null;
  let activityChart=null;

  function escapeHtml(str){
    return String(str??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function setStatus(message,isLoading=false){
    const el=document.getElementById("status");
    el.innerHTML=isLoading?`<span class="loading-spinner"></span>${escapeHtml(message)}`:escapeHtml(message);
  }
  function setError(message){ document.getElementById("error").textContent = message || ""; }
  function setBusy(isBusy){ document.getElementById("refreshBtn").disabled = isBusy; }

  function destroyIf(c){ if(c) c.destroy(); return null; }

  function buildBar(ctx, labels, datasets){
    return new Chart(ctx,{
      type:"bar",
      data:{labels, datasets},
      options:{
        responsive:true,
        plugins:{ legend:{display:false} },
        scales:{
          x:{ ticks:{ maxRotation:45, minRotation:0, autoSkip:true } },
          y:{ beginAtZero:true, ticks:{ precision:0 } }
        }
      }
    });
  }

  function safeGetFn(path){
    // path: "project.getGroups" etc.
    const parts=path.split(".");
    let obj=API;
    for(const p of parts){
      if(!obj || !(p in obj)) return null;
      obj=obj[p];
    }
    return (typeof obj === "function") ? obj.bind(parts.length>1 ? parts.slice(0,-1).reduce((o,k)=>o?.[k], API) : API) : null;
  }

  async function tryCall(paths, args){
    // tries multiple function paths until one works
    for(const p of paths){
      const fn = safeGetFn(p);
      if(!fn) continue;
      try{
        return { ok:true, used:p, value: await fn(...(args||[])) };
      }catch(e){
        // try next
      }
    }
    return { ok:false, used:null, value:null };
  }

  // ===== LOADERS =====

  async function loadCustomGroups(){
    const noteEl=document.getElementById("groupsNote");

    // Try known variants
    const res = await tryCall([
      "project.getGroups",
      "team.getGroups",
      "groups.getGroups"
    ]);

    if(!res.ok){
      noteEl.textContent =
        "Kunne ikke hente grupper via Workspace API i dette miljøet. " +
        "Sjekk om API-et eksponerer project.getGroups() / team.getGroups().";
      document.getElementById("groupsCount").textContent = "–";
      groupsChart = destroyIf(groupsChart);
      return;
    }

    const groups = Array.isArray(res.value) ? res.value : [];
    // Filter: custom groups (best-effort)
    const custom = groups.filter(g => (g?.type === "custom") || (g?.isCustom === true) || (g?.scope === "custom") || (g?.name && String(g.name).toLowerCase().includes("team")));
    // If filter removes everything, fall back to all groups
    const usedGroups = custom.length ? custom : groups;

    const labels=[];
    const counts=[];

    // member listing
    for(const g of usedGroups){
      const gid = g.id || g.groupId || g.uuid;
      const gname = g.name || g.title || ("Group " + (labels.length+1));
      if(!gid){
        labels.push(gname);
        counts.push(0);
        continue;
      }

      const membersRes = await tryCall([
        "project.getGroupMembers",
        "team.getGroupMembers",
        "project.getMembersByGroup",
        "team.getMembersByGroup"
      ], [gid]);

      const members = membersRes.ok && Array.isArray(membersRes.value) ? membersRes.value : [];
      labels.push(gname);
      counts.push(members.length);
    }

    document.getElementById("groupsCount").textContent = String(usedGroups.length);

    groupsChart = destroyIf(groupsChart);
    groupsChart = buildBar(document.getElementById("groupsChart").getContext("2d"), labels, [{
      label:"Antall personer",
      data: counts
    }]);

    noteEl.textContent =
      `Kilde: ${res.used}. Viser ${usedGroups.length} grupper.`;
  }

  async function loadViewsAndReleases(){
    // Views
    const viewsRes = await tryCall([
      "views.getViews",
      "view.getViews",
      "project.getViews"
    ]);
    if(viewsRes.ok){
      const views = Array.isArray(viewsRes.value) ? viewsRes.value : [];
      document.getElementById("viewsCount").textContent = String(views.length);
    }else{
      document.getElementById("viewsCount").textContent = "–";
    }

    // Releases
    const relRes = await tryCall([
      "releases.getReleases",
      "release.getReleases",
      "project.getReleases"
    ]);
    if(relRes.ok){
      const rel = Array.isArray(relRes.value) ? relRes.value : [];
      document.getElementById("releasesCount").textContent = String(rel.length);
    }else{
      document.getElementById("releasesCount").textContent = "–";
    }
  }

  async function loadExplorerFolderBreakdown(){
    const noteEl=document.getElementById("foldersNote");

    // We try several likely APIs. Because Workspace API differs between tenants/versions,
    // we do best-effort and explain if it isn't available.
    //
    // Strategy:
    // 1) Get a root folder/container id
    // 2) List folders under root
    // 3) For each folder, count files (direct children). (Optional: recursive)
    //
    // Try to get a root id
    const rootRes = await tryCall([
      "data.getRootFolder",
      "data.getProjectRoot",
      "data.getRoot",
      "files.getRootFolder",
      "files.getRoot"
    ]);

    let root = rootRes.ok ? rootRes.value : null;
    let rootId = root?.id || root?.folderId || root?.uuid || null;

    // If we didn't get a root object, some APIs allow listing folders without parent
    const listFoldersRes = await tryCall([
      "data.getFolders",
      "files.getFolders",
      "data.listFolders",
      "files.listFolders"
    ], rootId ? [rootId] : []);

    // Normalize folder list
    let folders = [];
    if(listFoldersRes.ok){
      folders = Array.isArray(listFoldersRes.value) ? listFoldersRes.value : (Array.isArray(listFoldersRes.value?.items) ? listFoldersRes.value.items : []);
    } else {
      // Try an alternative: get a tree (flat) then aggregate
      const treeRes = await tryCall([
        "data.getTree",
        "files.getTree",
        "data.getFolderTree",
        "files.getFolderTree"
      ], []);
      if(treeRes.ok){
        // Expect array of nodes with type: folder/file and parentId
        const nodes = Array.isArray(treeRes.value) ? treeRes.value : [];
        const folderNodes = nodes.filter(n => (n.type === "folder") || (n.kind === "folder") || (n.isFolder === true));
        const fileNodes = nodes.filter(n => (n.type === "file") || (n.kind === "file") || (n.isFile === true));
        // Map folder -> direct file count
        const folderById = new Map(folderNodes.map(f => [f.id || f.folderId || f.uuid, f]));
        const countsByFolderId = {};
        for(const f of folderNodes){
          const fid = f.id || f.folderId || f.uuid;
          if(fid) countsByFolderId[fid] = 0;
        }
        for(const file of fileNodes){
          const pid = file.parentId || file.folderId || file.parentFolderId;
          if(pid && pid in countsByFolderId) countsByFolderId[pid] += 1;
        }
        const labels = folderNodes.slice(0, 20).map(f => f.name || f.title || "Mappe");
        const counts = folderNodes.slice(0, 20).map(f => countsByFolderId[f.id || f.folderId || f.uuid] || 0);

        foldersChart = destroyIf(foldersChart);
        foldersChart = buildBar(document.getElementById("foldersChart").getContext("2d"), labels, [{
          label:"Antall filer (direkte)",
          data: counts
        }]);

        noteEl.textContent =
          `Kilde: ${treeRes.used}. Viser de 20 første mappene (direkte filer).`;
        return;
      }

      // If we still can't fetch anything
      foldersChart = destroyIf(foldersChart);
      noteEl.textContent =
        "Kunne ikke hente mappe-/filstruktur fra Explorer i dette miljøet. " +
        "Workspace API varierer: forventet f.eks. data.getFolders(rootId) eller data.getTree().";
      return;
    }

    // Count files per folder (best-effort, direct children)
    const labels=[];
    const counts=[];
    const MAX_FOLDERS = 20; // avoid heavy API calls

    for(const folder of folders.slice(0, MAX_FOLDERS)){
      const fid = folder.id || folder.folderId || folder.uuid;
      const fname = folder.name || folder.title || "Mappe";
      labels.push(fname);

      if(!fid){
        counts.push(0);
        continue;
      }

      const contentRes = await tryCall([
        "data.getFolderContent",
        "files.getFolderContent",
        "data.listFolderContent",
        "files.listFolderContent",
        "data.getItems",
        "files.getItems"
      ], [fid]);

      let items = [];
      if(contentRes.ok){
        items = Array.isArray(contentRes.value) ? contentRes.value : (Array.isArray(contentRes.value?.items) ? contentRes.value.items : []);
      }

      const filesOnly = items.filter(it => (it.type === "file") || (it.kind === "file") || (it.isFile === true) || (it.fileId) || (it.versionId));
      counts.push(filesOnly.length);
    }

    foldersChart = destroyIf(foldersChart);
    foldersChart = buildBar(document.getElementById("foldersChart").getContext("2d"), labels, [{
      label:"Antall filer (direkte)",
      data: counts
    }]);

    noteEl.textContent =
      `Kilde: ${listFoldersRes.used}${rootRes.ok ? " (root: " + (rootRes.used) + ")" : ""}. ` +
      `Viser de ${Math.min(MAX_FOLDERS, folders.length)} første mappene (direkte filer).`;
  }

  async function loadActivities(){
    const noteEl=document.getElementById("activityNote");

    // Try to fetch activities / audit log
    const actRes = await tryCall([
      "activity.getActivities",
      "activity.getProjectActivities",
      "project.getActivities",
      "audit.getEvents",
      "events.getEvents"
    ]);

    if(!actRes.ok){
      activityChart = destroyIf(activityChart);
      noteEl.textContent =
        "Kunne ikke hente aktivitetslogg i dette miljøet via Workspace API. " +
        "Hvis tenant ikke eksponerer activity/audit-modul, kan dette være utilgjengelig.";
      return;
    }

    const items = Array.isArray(actRes.value) ? actRes.value : (Array.isArray(actRes.value?.items) ? actRes.value.items : []);
    // Count by type
    const counts = {};
    for(const a of items){
      const t = (a.type || a.eventType || a.action || a.name || "Unknown").toString();
      counts[t] = (counts[t] || 0) + 1;
    }

    const labels = Object.keys(counts).sort((a,b)=>a.localeCompare(b)).slice(0, 20);
    const data = labels.map(l => counts[l]);

    activityChart = destroyIf(activityChart);
    activityChart = buildBar(document.getElementById("activityChart").getContext("2d"), labels, [{
      label:"Antall hendelser",
      data
    }]);

    noteEl.textContent =
      `Kilde: ${actRes.used}. Viser de 20 mest relevante aktivitetstypene (totalt: ${items.length} hendelser).`;
  }

  async function refreshAll(){
    setBusy(true);
    setError("");
    setStatus("Henter prosjektdata …", true);

    try{
      await loadViewsAndReleases();
      await loadCustomGroups();
      await loadExplorerFolderBreakdown();
      await loadActivities();

      setStatus("Sist oppdatert: " + new Date().toLocaleString());
    }catch(err){
      console.error(err);
      setError("Feil ved henting av prosjektdata: " + (err?.message || err));
      setStatus("Klar, men med feil ved siste oppdatering.");
    }finally{
      setBusy(false);
    }
  }

  async function init(){
    setStatus("Kobler til Trimble Connect …", true);
    try{
      API = await TrimbleConnectWorkspace.connect(window.parent);
      await refreshAll();
    }catch(err){
      console.error(err);
      setError("Klarte ikke å koble til Trimble Connect Workspace API: " + (err?.message || err));
      setStatus("Feil ved initialisering.");
    }
  }

  document.getElementById("refreshBtn").addEventListener("click", refreshAll);
  window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
