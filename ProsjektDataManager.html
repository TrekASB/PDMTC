<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>2ProsjektDataManager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#0069d9;
      --border:#e5e7eb;
      --card:#ffffff;
      --bg:#f5f5f7;
      --text:#111827;
      --muted:#6b7280;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 16px;
      background:var(--card);
      border-bottom:1px solid var(--border);
    }

    .logo{
      width:72px;
      height:72px;
      border-radius:10px;
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }

    .titleBlock{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .title{
      font-weight:900;
      font-size:18px;
      color:var(--primary);
    }

    .org{
      font-weight:700;
      font-size:13px;
    }

    .dev{
      font-size:11px;
      opacity:.75;
      font-style:italic;
    }

    .headerRight{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    button{
      padding:7px 12px;
      border-radius:8px;
      border:1px solid var(--primary);
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }

    main{
      padding:16px;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(360px,1fr));
      gap:16px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      min-height:260px;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
      font-weight:900;
    }

    .kpi{
      font-size:34px;
      font-weight:900;
      color:var(--primary);
    }

    canvas{
      width:100% !important;
      height:260px !important;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    .error{
      color:#b00020;
      font-size:13px;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="logo">NC</div>

  <div class="titleBlock">
    <div class="title">2ProsjektDataManager</div>
    <div class="org">Norconsult Norge</div>
    <div class="dev">Developed by Edin Dzakmic, Norconsult (AI-assisted development)</div>
  </div>

  <div class="headerRight">
    <div id="headerStatus" class="status">Initialiserer …</div>
    <button id="refreshBtn">Oppdater data</button>
  </div>
</header>

<main>
  <div class="card">
    <h2>Prosjektmedlemmer</h2>
    <div id="membersKpi" class="kpi">–</div>
    <div class="status">Antall brukere i prosjektet</div>
  </div>

  <div class="card">
    <h2>Custom Groups</h2>
    <canvas id="groupsChart"></canvas>
    <div class="status">Antall personer per gruppe</div>
  </div>

  <div class="card">
    <h2>Delinger (Shared)</h2>
    <canvas id="sharesChart"></canvas>
    <div class="status">Delinger over tid</div>
  </div>

  <div class="card">
    <h2>Aktiviteter (Object Sync)</h2>
    <canvas id="activityChart"></canvas>
    <div class="status">Endringer per objekttype</div>
  </div>

  <div class="card">
    <h2>Feilmeldinger / status</h2>
    <div id="errorBox" class="error"></div>
  </div>
</main>

<script>
let API = null;
let accessToken = null;
let projectId = null;

/* ------------------ HELPERS ------------------ */
function setHeaderStatus(txt){ document.getElementById("headerStatus").textContent = txt; }
function setError(txt){ document.getElementById("errorBox").textContent = txt || ""; }
function destroy(chart){ if(chart) chart.destroy(); return null; }

/* ------------------ CHARTS ------------------ */
let groupsChart = null;
let sharesChart = null;
let activityChart = null;

/* ------------------ API HELPERS ------------------ */
async function coreFetch(url){
  if(!accessToken) throw new Error("Fant ikke access token via Workspace API.");
  const res = await fetch(url,{
    headers:{
      "Authorization":"Bearer "+accessToken,
      "Accept":"application/json"
    }
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(res.status+" "+t);
  }
  return res.json();
}

/* ------------------ DATA LOADERS ------------------ */
async function loadMembers(){
  // Core API – users in project
  const data = await coreFetch(`https://app.connect.trimble.com/tc/api/2.0/projects/${projectId}/users`);
  document.getElementById("membersKpi").textContent = data.length;
}

async function loadGroups(){
  const groups = await coreFetch(`https://app.connect.trimble.com/tc/api/2.0/projects/${projectId}/groups`);
  const labels=[], values=[];
  for(const g of groups){
    const members = await coreFetch(`https://app.connect.trimble.com/tc/api/2.0/groups/${g.id}/users`);
    labels.push(g.name);
    values.push(members.length);
  }

  groupsChart = destroy(groupsChart);
  groupsChart = new Chart(document.getElementById("groupsChart"),{
    type:"bar",
    data:{labels,datasets:[{label:"Antall",data:values}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}

async function loadShares(){
  const shares = await coreFetch(`https://app.connect.trimble.com/tc/api/2.0/projects/${projectId}/shares`);
  const counts = {};
  for(const s of shares){
    const d = s.createdAt?.substring(0,10) || "Ukjent";
    counts[d]=(counts[d]||0)+1;
  }

  const labels = Object.keys(counts).sort();
  const values = labels.map(l=>counts[l]);

  sharesChart = destroy(sharesChart);
  sharesChart = new Chart(document.getElementById("sharesChart"),{
    type:"line",
    data:{labels,datasets:[{label:"Delinger",data:values}]}
  });
}

async function loadActivity(){
  const changes = await coreFetch(`https://app.connect.trimble.com/tc/api/2.0/projects/${projectId}/objects/changes`);
  const counts = {};
  for(const c of changes){
    const t = c.objectType || "Ukjent";
    counts[t]=(counts[t]||0)+1;
  }

  const labels = Object.keys(counts);
  const values = labels.map(l=>counts[l]);

  activityChart = destroy(activityChart);
  activityChart = new Chart(document.getElementById("activityChart"),{
    type:"pie",
    data:{labels,datasets:[{data:values}]}
  });
}

/* ------------------ MAIN ------------------ */
async function refresh(){
  setError("");
  setHeaderStatus("Henter data …");
  try{
    await loadMembers();
    await loadGroups();
    await loadShares();
    await loadActivity();
    setHeaderStatus("Oppdatert " + new Date().toLocaleString());
  }catch(e){
    setError(e.message);
    setHeaderStatus("Feil ved lasting");
  }
}

/* ------------------ INIT ------------------ */
async function init(){
  setHeaderStatus("Kobler til Trimble Connect …");
  API = await TrimbleConnectWorkspace.connect(window.parent,(event,args)=>{
    if(event==="extension.accessToken"){
      accessToken = args.data?.accessToken || args.data;
      if(accessToken) refresh();
    }
  });

  const project = await API.project.getCurrentProject();
  projectId = project.id;

  const perm = await API.extension.requestPermission("accesstoken");
  if(perm?.accessToken){
    accessToken = perm.accessToken;
    refresh();
  }
}

document.getElementById("refreshBtn").addEventListener("click",refresh);
window.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
